# 部署到阿里云 & 提交到 GitHub（不提交 application / README）

## 一、重新打包并部署到阿里云

在**本机**项目根目录执行：

```bash
# 1. 打包（前端 + 后端，生成 jar）
./scripts/deploy.sh

# 2. 上传 jar 到 ECS（把 你的公网IP 换成阿里云 ECS 的公网 IP）
scp target/interview-assistant-1.0.0.jar root@你的公网IP:/opt/

# 3. SSH 登录服务器后彻底重启（关键：确保旧进程死透、加载新 jar）
ssh root@你的公网IP
sudo pkill -9 java
sudo systemctl restart interview-assistant
```

**重要**：若只执行 `systemctl restart` 而旧 Java 进程未完全退出，可能仍会跑旧代码，导致智能助手链接出现 `" target="_blank" rel="noopener noreferrer">` 等乱码。务必先 `pkill -9 java` 再 `systemctl restart`。

**如何确认新代码已生效**：部署后发「给我一道算法题」，若回复里出现 **「立即练习（链接已修复）」**，说明新 JAR 已在跑；若仍是「立即练习」且无「链接已修复」，或链接后还有 `target="_blank"` 乱码，多半是旧 JAR 仍在运行，请按上一步强杀后再重启。

完成后浏览器 **Ctrl+F5 强制刷新**，并**新开对话**再测（旧对话可能沿用旧回复）。**不需要**重新执行 `setup-ecs.sh`，也不用改 `/opt/interview-assistant.env`（除非你要改 API Key 或密码）。

---

## 二、把修改推送到 GitHub（不提交 application.yml 和 README.md）

你本地的 `application.yml` 里有 API Key 和密码，`README.md` 也不想覆盖 GitHub 上的，所以提交时**不要**把这两个文件加入提交。

### 方法一：先加所有改动，再取消暂存这两个文件（推荐）

在项目根目录执行：

```bash
# 1. 查看当前有哪些文件被修改或新增
git status

# 2. 先添加所有改动
git add -A

# 3. 把 application.yml 和 README.md 从“待提交”里拿掉（不删除文件，只是不提交）
git reset HEAD src/main/resources/application.yml
git reset HEAD README.md

# 4. 再确认一下：列表中不应出现 application.yml 和 README.md
git status

# 5. 提交并推送
git commit -m "这里写本次修改的说明，如：算法题原题出处、编辑功能等"
git push origin main
```

这样只有**除 application.yml 和 README.md 以外**的修改会被提交并推送到 GitHub。

### 方法二：只添加要提交的文件

不想用 `git add -A` 的话，可以只加需要的路径（同样不要加 application 和 readme）：

```bash
git status

# 只添加这些（按你实际改动的目录来，不要写 application.yml 和 README.md）
git add frontend/
git add src/main/java/
git add scripts/
git add pom.xml
# 若有其他改动目录，例如 docs/，再补一行：git add docs/

git status
git commit -m "本次修改说明"
git push origin main
```

---

## 三、每次提交前自检

- 执行 `git status` 后，在 **Changes to be committed** 里不要出现：
  - `src/main/resources/application.yml`
  - `README.md`
- 若不小心已经 `git add` 了这两个，用下面的命令从暂存区移除后再提交：

```bash
git reset HEAD src/main/resources/application.yml
git reset HEAD README.md
```

---

## 四、新项目第一次上传到 GitHub（若还没建过仓库）

若这是**全新**项目、还没在 GitHub 建过仓库，可以按下面做（同样不提交 application 和 readme）：

```bash
# 1. 在 GitHub 网页上新建一个空仓库（不要勾选 README / .gitignore）

# 2. 在项目根目录初始化并关联远程
git init
git remote add origin https://github.com/你的用户名/仓库名.git

# 3. 添加除 application.yml、README.md 以外的文件
git add -A
git reset HEAD src/main/resources/application.yml
git reset HEAD README.md

# 4. 首次提交并推送
git branch -M main
git commit -m "Initial commit"
git push -u origin main
```

之后每次有修改，都按 **「二」** 的步骤做即可：重新打包部署到阿里云，然后按「方法一」或「方法二」提交到 GitHub，且始终不提交本地的 `application.yml` 和 `README.md`。

---

## 五、在线 IDE 运行代码报 connection timed out

在线 IDE 依赖外部接口 [Piston](https://github.com/emkcorg/piston)（默认 `emkc.org`）执行代码。若部署在境内或网络受限，可能连不上导致 **connection timed out**。

- **超时时间**：默认 30 秒。若仍超时，可在 `application.yml` 中酌情调大（例如 45、60）：
  ```yaml
  piston:
    api-url: https://emkc.org/api/v2/piston
    timeout-seconds: 30
  ```
- **换网络/代理**：确保部署该应用的服务器能访问 `emkc.org`（或自建 Piston 后改 `piston.api-url`）。
- **自建 Piston**：若无法访问公网 Piston，可自行部署 Piston 服务，并把 `piston.api-url` 改为自建地址。详细步骤见 [自建Piston代码执行.md](./自建Piston代码执行.md)。

---

## 六、简历仅管理员可查看/下载

简历列表、详情、下载、预览接口均已要求**管理员密码**。未输入正确密码的人无法通过直接访问网址预览或下载简历，只有知道管理员密码的人可以。
