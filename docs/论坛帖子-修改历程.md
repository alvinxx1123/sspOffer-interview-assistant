# 【经验帖】面经助手在线 IDE 从本地到阿里云部署的一路踩坑与修复

## 背景

我在做「sspOffer 面经助手」项目，里面有一个在线算法 IDE：支持在题库里选题、写代码、点运行看结果（ACM 白板模式）。本地开发时一切正常，但部署到阿里云 ECS 之后，在线 IDE 运行代码一直失败，题库添加题目也报密码错误。下面按时间顺序记录问题和解决过程，给遇到类似情况的同学参考。

---

## 一、在线 IDE 题库「添加」失败：密码错误

**现象**：在在线 IDE 里点「+ 添加」新算法题时，接口返回 403，提示需要管理员密码或密码错误。

**原因**：后端对修改类接口（添加/编辑/删除题目等）做了简单密码校验，请求头里必须带 `X-Admin-Password`，且要和配置里的一致。  
我虽然在 `application.yml` 里已经写死了自己设的 `app.admin-password`，但部署到服务器时用的是 **环境变量** 或 **env 文件** 启动，没有把同一套密码配进去，导致后端实际读到的密码和前端/预期不一致。

**解决**：

- **阿里云 ECS 上**：在 systemd 的 `EnvironmentFile`（例如 `/opt/interview-assistant.env`）或启动脚本里加上：
  ```bash
  APP_ADMIN_PASSWORD=你设置的密码
  ```
  和你在本地/前端使用的密码保持一致。
- **本地**：若用 `application-local.yml`，在里面写 `app.admin-password` 即可；若用环境变量，同样要 `export APP_ADMIN_PASSWORD=xxx`。

结论：**只要用环境变量或 env 文件启动，就必须在那里也写上管理员密码**，不能只依赖 application 里曾经硬编码的值，否则会一直报密码错误。

---

## 二、题库算法题：支持编辑、出处与链接

在修好密码之后，顺带把题库能力补全了：

- **编辑**：每道题支持编辑（标题、描述、难度、默认代码等）。
- **出处与链接**：可以填「来源」（如力扣、原题）、力扣题 slug、原题链接；前端会显示「力扣原题」等链接，方便跳转刷题。

这样题库既是题目列表，又带出处和跳转，用起来更顺手。

---

## 三、本地能运行代码，部署到阿里云后超时/运行失败

**现象**：  
本地点「运行」能正常出结果；同一份代码部署到阿里云后，点运行要么一直转圈然后报错，要么提示「执行失败: Failed to fetch」或「Host is not specified」，没有输出。

**原因简要**：

1. **代码执行走的是公网 Piston API**（默认 `emkc.org`），从国内 ECS 访问国外服务容易超时或不稳定，请求一久前端就「Failed to fetch」。
2. 若在服务器上配置了自建 Piston 的地址，但 **环境变量没生效**（例如没写 `PISTON_API_URL` 或没重启服务），后端仍会用空或错误地址去连，报「Host is not specified」或连不上。
3. **自建 Piston 没启动或端口没开**：后端会长时间等 Piston，导致请求超时，前端同样会显示「Failed to fetch」。

所以要同时保证：**环境变量里配好 Piston 地址**、**自建 Piston 容器在跑且端口通**、**Nginx 等代理超时时间足够**（建议 ≥60s）。

---

## 四、用 Docker 自建 Piston 代码执行引擎

为了在阿里云上稳定跑代码，我改成在**同一台 ECS 上用 Docker 自建 Piston**，让面经助手只访问本机 `http://127.0.0.1:2000/api/v2`，不再依赖公网。

**大致步骤**（以 Ubuntu 为例）：

1. **安装 Docker**（如未安装）：  
   `apt update && apt install -y docker.io`，并 `systemctl start docker`。

2. **准备 Piston 数据目录**：  
   克隆 Piston 仓库到宿主机（如 `/opt/piston-data`），**删掉仓库里的 `packages` 目录并新建空 `packages`**（Piston 会把语言运行时装在这里），否则容器容易报错或扫到错误路径。

3. **启动容器**：  
   用官方镜像 `ghcr.io/engineer-man/piston`，挂载上面目录到 `/piston`，映射端口 `2000:2000`，`--restart unless-stopped`。

4. **在容器内安装语言**：  
   用 Piston 自带的 CLI（如 `node /piston/cli/index.js ppman install java/python/go`）在容器里装 Java、Python 等，否则运行对应语言会报 runtime 相关错误。

5. **配置面经助手**：  
   在服务器环境变量或 env 里设置：
   ```bash
   PISTON_API_URL=http://127.0.0.1:2000/api/v2
   ```
   然后重启面经助手服务（如 `systemctl restart interview-assistant`）。

6. **自检**：  
   在 ECS 上执行 `curl -s http://127.0.0.1:2000/api/v2/runtimes` 能返回 JSON，说明 Piston 正常；再在页面上点「运行」应能正常出结果。

过程中还遇到过：克隆后没清空 `packages` 导致 `ENOTDIR`、安装语言时卡住（可去掉 `docker exec` 的 `-it`）、国内下载语言包慢等，都在项目里的「自建 Piston 代码执行」文档里写了排查和解决。

---

## 五、其他小修复与体验

- **Java 无 main 时误注入 twoSum**：若代码里写的是 `private static void main` 或没写 `public static void main`，后端会误判为「没有 main」并注入两数之和的测试代码，导致报错。已改为只要检测到 `static void main` 就按用户自己的入口执行，不再注入。
- **运行完成却无输出**：当执行成功但程序没打印任何内容时，前端会提示「运行完成。（程序未产生标准输出…）」并自动滚到输出区，避免误以为没反应。
- **Failed to fetch 提示**：前端对这类网络错误做了友好提示，引导检查 Piston 是否启动、后端是否可访问。

---

## 总结

- **题库添加失败 / 密码错误**：在部署环境（env 或环境变量）里显式配置 `APP_ADMIN_PASSWORD`，与前端使用的密码一致。
- **题库能力**：算法题支持编辑、填写出处和链接，方便整理和跳转。
- **本地能跑、服务器上超时/失败**：多半是代码执行服务（默认公网 Piston）在服务器侧不可用或超时；建议在同一台 ECS 上用 Docker 自建 Piston，并在环境变量中配置 `PISTON_API_URL`，重启应用后再测。

项目里有一份「自建 Piston 代码执行」文档，把部署步骤、常见报错和排查都写进去了，需要的话可以在仓库里翻一下。  
如果大家有类似「本地正常、上云就挂」或 Piston 自建的问题，欢迎一起交流。
